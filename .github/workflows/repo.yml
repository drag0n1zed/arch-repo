name: Build and Deploy Repo

# Allow the final deploying step to write
permissions:
  contents: write

# Run when..
on: 
  # ..a push happens
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'index.html'
      - '.github/workflows/**'
  
  # ..the daily schedule happens
  schedule:
    - cron: '0 8 * * *'

  # ..manually triggered
  workflow_dispatch:

jobs:
  prep-matrix:
    runs-on: ubuntu-latest
    container: archlinux:latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for git diff

      - name: Install Tools
        run: |
          pacman -Syu --noconfirm base-devel git jq

      - name: Create Build User
        run: |
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builduser:builduser $PWD

      - name: Calculate Build Matrix
        id: set-matrix
        shell: bash
        run: |

          set -euo pipefail
          # config
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/repo-host/x86_64"
          REPO_NAME="drags-repo"
          PACKAGE_ROOT="packages"
    
          # setup repo 
          echo "::group::Configuring Pacman for ${REPO_NAME}"
          # Configure pacman to use the custom repository for version comparison.
          # The '|| true' handles the case where the repo DB doesn't exist yet on the first run.
          printf "\n[%s]\nSigLevel = Optional TrustAll\nServer = %s\n" "$REPO_NAME" "$REPO_URL" | sudo tee -a /etc/pacman.conf
          sudo pacman -Sy --noconfirm || echo "::warning::Could not sync ${REPO_NAME} database. This is expected on the first run."
          echo "::endgroup::"
    
          # scan package
          TO_BUILD=()
          echo "Scanning for packages in '${PACKAGE_ROOT}' that require building..."
    
          for pkgbuild_path in "$PACKAGE_ROOT"/*/PKGBUILD; do
            pkg_dir=$(dirname "$pkgbuild_path")
      
            # generate .SRCINFO in a subshell to get dynamic version without downloading sources.
            # 'set -e' ensures the script fails immediately if makepkg encounters an error.
            srcinfo_output=$(cd "$pkg_dir" && sudo -u builduser makepkg --printsrcinfo)
    
            # parse name and version from the generated .SRCINFO
            pkg_name=$(awk -F ' = ' '/^\s*pkgname\s*=/ {print $2}' <<< "$srcinfo_output")
            full_new_ver=$(awk -F ' = ' '/^\s*pkgver\s*=/ {print $2}' <<< "$srcinfo_output")
    
            # query the repo DB for the currently published version, default to "0" if not found.
            repo_ver=$(pacman -Si "$pkg_name" 2>/dev/null | awk '/^Version/ {print $3}' || echo "0")
    
            echo "==> Checking ${pkg_name}: Repo [${repo_ver}] vs Local [${full_new_ver}]"
      
            # compare versions, add to queue if local version newer or package is new.
            if [[ "$repo_ver" == "0" ]]; then
              echo " -> New package. Adding to build queue."
              TO_BUILD+=("$pkg_dir")
            elif [[ $(vercmp "$full_new_ver" "$repo_ver") -gt 0 ]]; then
              echo " -> Update found. Adding to build queue."
              TO_BUILD+=("$pkg_dir")
            fi
          done
    
          # output
          if [ ${#TO_BUILD[@]} -eq 0 ]; then
            echo "::notice::No packages need to be built. The repository is up-to-date."
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Found ${#TO_BUILD[@]} package(s) to build."
            echo "The following packages will be added to the build matrix:"
            printf "  - %s\n" "${TO_BUILD[@]}"

            # Create a JSON array of package directories for the GitHub Actions matrix.
            json_matrix=$(printf '%s\n' "${TO_BUILD[@]}" | jq -R . | jq -sc)
            echo "matrix=${json_matrix}" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: prep-matrix
    # If prep-matrix returns empty list, prevents running
    if: ${{ needs.prep-matrix.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    container: archlinux:latest
    strategy:
      fail-fast: false # One failed package doesn't stop the rest
      matrix:
        package_path: ${{ fromJson(needs.prep-matrix.outputs.matrix) }}

    steps:
      - name: Prep environment
        run: |
          pacman -Syu --noconfirm base-devel git sudo

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create build user
        run: |
          useradd -m builduser
          # Passwordless sudo for the user
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          # Give ownership of the repo to the user
          chown -R builduser:builduser $PWD

      - name: Build ${{ matrix.package_path }}
        run: |
          echo "::group::Building ${{ matrix.package_path }}"
          cd "${{ matrix.package_path }}"
          # -s: install dependencies
          # -f: force a check
          # -c: clean up source files after build
          # Uses the builduser
          sudo -u builduser makepkg -sfc --noconfirm --force
          echo "::endgroup::"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-packages-${{ strategy.job-index }} # Unique names for each artifact
          path: ${{ matrix.package_path }}/*.pkg.tar.zst # Take only *.zst
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Prep environment
        run: |
          pacman -Syu --noconfirm base-devel git github-cli

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore Existing DB
        continue-on-error: true
        run: |
          mkdir -p repo/x86_64
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/repo-host/x86_64"
          echo "Fetching existing DB from $REPO_URL"
          
          # Download db.tar.zst and save as .db (repo-add requirement)
          curl -L -f -o repo/x86_64/repo.db.tar.zst "$REPO_URL/repo.db.tar.zst" || echo "First run or DB missing."

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: built-packages-*
          merge-multiple: true
          path: repo/x86_64

      - name: Update pacman database
        run: |
          cd repo/x86_64
          # Check if files actually exist
          if ls *.pkg.tar.zst 1> /dev/null 2>&1; then
            repo-add -n -R repo.db.tar.zst *.pkg.tar.zst
          fi
      
      - name: Upload binaries to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: packages
          name: "Package Repository"
          files: repo/x86_64/*.pkg.tar.zst
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean and Prepare
        run: |
          # Delete the heavy binaries so they don't bloat the git repo
          rm repo/x86_64/*.pkg.tar.zst
          rm repo/x86_64/*.pkg.tar.zst.sig || true
          
          # Copy index.html to the deploy folder
          cp index.html repo/index.html || echo "No index.html found, skipping."
      
      - name: Push DB & Site
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: repo-host
          force_orphan: true
          commit_message: "Update repo database [skip ci]"