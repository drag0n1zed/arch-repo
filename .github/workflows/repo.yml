name: Build and Deploy Repo to Vercel Branch

# Run when..
on: 
  # ..a push to packages/** happens
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - '.github/workflows/**'
  
  # ..the daily schedule happens
  schedule:
    - cron: '0 8 * * *'

  # ..manually triggered
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Prep environment
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm base-devel git sudo

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create build user
        run: |
          useradd -m builduser
          # Passwordless sudo for the user
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          # Give ownership of the repo to the user
          chown -R builduser:builduser $PWD
      
      - name: Create staging directory
        run: mkdir -p repo/x86_64
      
      - name: Find packages to build
        id: packages_to_build
        run: |
            PACKAGES_TO_BUILD=$(find packages -name PKGBUILD -exec dirname {} \;)
            echo "Found packages to build:"
            echo "${PACKAGES_TO_BUILD}"
            echo "list=${PACKAGES_TO_BUILD}" >> $GITHUB_OUTPUT

      - name: Build packages
        run: |
          for pkg in ${{ steps.packages_to_build.outputs.list }}; do
            echo "::group::Building $pkg"
            cd "$pkg"
            # -s: install dependencies
            # -f: force a check
            # -c: clean up source files after build
            # Uses the builduser
            sudo -u builduser makepkg -sfc --noconfirm
            find . -maxdepth 1 -name "*.pkg.tar.zst" -exec mv {} ../../repo/x86_64/ \;
            cd ../..
            echo "::endgroup::"
          done

      - name: Update pacman database
        run: |
          cd repo/x86_64
          if ls *.pkg.tar.zst 1> /dev/null 2>&1; then
            echo "Updating repo database..."
            repo-add drags-repo.db.tar.zst *.pkg.tar.zst
          else
            echo "No packages were built, skipping database update."
            exit 0
          fi
      
      - name: Deploy to Vercel branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: vercel
          force_orphan: true
          commit_message: "Deploy updated repo packages"