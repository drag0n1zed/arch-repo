name: Repo Builder

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    strategy:
      fail-fast: false
      matrix:
        pkg: [gephgui-wry-bin]
    
    steps:
      - name: Install Tools
        run: |
          pacman-key --init && pacman-key --populate archlinux
          pacman -Syu --noconfirm git pacman-contrib

      - uses: actions/checkout@v4

      - name: Build Package
        id: build
        working-directory: packages/${{ matrix.pkg }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # update.sh handles version checks and runs makepkg
        run: ./update.sh

      - name: Upload Binaries
        if: steps.build.outputs.built == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.pkg }}
          path: |
              packages/${{ matrix.pkg }}/*.pkg.tar.zst
              packages/${{ matrix.pkg }}/PKGBUILD
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest
    # Run deploy inside Arch to access 'repo-add' natively
    container: archlinux:base-devel
    if: success() # Only run if builds succeeded

    steps:
      - name: Install Tools
        # NodeJS is required to run the 'actions/checkout' and 'gh-pages' plugins
        run: |
          pacman-key --init && pacman-key --populate archlinux
          pacman -Syu --noconfirm git openssh rsync nodejs

      # 1. Update Source (PKGBUILDs) ------------------------------------------
      - uses: actions/checkout@v4
        with:
          path: source

      - name: Download New Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pkg-*
          merge-multiple: true
          path: built_packages

      - name: Commit PKGBUILD Updates
        working-directory: source
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # If artifacts exist, it means update.sh modified PKGBUILDs. Commit them.
          if [ -n "$(ls -A ../built_packages)" ]; then
            git add packages
            git commit -m "auto: update packages [skip ci]" || echo "No changes to commit"
            git push
          fi

      # 2. Update Repository Database -----------------------------------------
      - uses: actions/checkout@v4
        with:
          ref: vercel
          path: repo_root

      - name: Generate Repo DB
        run: |
          # Check if we actually have new packages
          if [ ! -d "built_packages" ] || [ -z "$(ls -A built_packages)" ]; then
            echo "No packages built. Exiting."
            exit 0
          fi

          mkdir -p repo_root/x86_64
          
          # Move new binaries to repo folder
          mv built_packages/*.pkg.tar.zst repo_root/x86_64/
          
          # Run repo-add
          cd repo_root/x86_64
          repo-add drags-repo.db.tar.gz *.pkg.tar.zst

      # 3. Deploy to Vercel Branch --------------------------------------------
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: repo_root
          publish_branch: vercel
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'