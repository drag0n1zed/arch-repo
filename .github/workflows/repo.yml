name: Build and Deploy Repo to Vercel Branch

# Allow the final deploying step to write
permissions:
  contents: write

# Run when..
on: 
  # ..a push to packages/** happens
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - '.github/workflows/**'
  
  # ..the daily schedule happens
  schedule:
    - cron: '0 8 * * *'

  # ..manually triggered
  workflow_dispatch:

jobs:
  prep-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Find packages
        id: set-matrix
        # 1. Find packages containing PKGBUILD
        # 2. strip the ./
        # 3. output as JSON array
        run: |
          MATRIX_JSON=$(find packages -name PKGBUILD -printf '%h\n' | jq -R -s -c 'split("\n")[:-1]')')
          echo "Found packages: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  build:
    needs: prep-matrix
    # If prep-matrix returns empty list, prevents running
    if: ${{ needs.prep-matrix.outputs.matrix != '[]' && needs.prep-matrix.outputs.matrix != '' }}
    runs-on: ubuntu-latest
    container: archlinux:latest
    strategy:
      fail-fast: false # One failed package doesn't stop the rest
      matrix:
        package_path: ${{ fromJson(needs.prep-matrix.outputs.matrix) }}

    steps:
      - name: Prep environment
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm base-devel git sudo

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create build user
        run: |
          useradd -m builduser
          # Passwordless sudo for the user
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          # Give ownership of the repo to the user
          chown -R builduser:builduser $PWD

      - name: Build ${{ matrix.package_path }}
        run: |
          echo "::group::Building ${{ matrix.package_path }}"
          cd "${{ matrix.package_path }}"
          # -s: install dependencies
          # -f: force a check
          # -c: clean up source files after build
          # Uses the builduser
          sudo -u builduser makepkg -sfc --noconfirm
          echo "::endgroup::"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ strategy.job-index }} # Unique names for each artifact
          path: ${{ matrix.package_path }}/*.pkg.tar.zst # Take only *.zst
          retention-days: 1
  deploy:
    needs: build
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Prep environment
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm base-devel git

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create staging directory
        run: mkdir -p repo/x86_64

      - name: Download all built packages
        uses: actions/download-artifact@v4
        with:
          pattern: pkg-*
          merge-multiple: true
          path: repo/x86_64

      - name: Update pacman database
        run: |
          cd repo/x86_64
          # Check if files actually exist
          if ls *.pkg.tar.zst 1> /dev/null 2>&1; then
            echo "Found packages, updating repo..."
            repo-add drags-repo.db.tar.zst *.pkg.tar.zst
          else
            echo "No packages found."
            exit 0
          fi
      
      - name: Deploy to Vercel branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: vercel
          force_orphan: true
          commit_message: "Deploy updated repo packages"